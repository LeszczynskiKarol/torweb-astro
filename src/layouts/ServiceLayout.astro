---
import '../styles/global.css';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';

interface FAQ {
  question: string;
  answer: string;
}

interface Props {
  // SEO
  title: string;
  description: string;
  keywords: string;
  canonical?: string;
  ogImage?: string;
  
  // Service Data
  serviceName: string;
  serviceSlug: string;
  serviceCategory: string;
  priceRange: string;
  
  // Breadcrumb
  breadcrumbName: string;
  
  // FAQ for Schema
  faqs?: FAQ[];
}

const { 
  title, 
  description,
  keywords,
  canonical,
  ogImage = '/og-image.jpg',
  serviceName,
  serviceSlug,
  serviceCategory,
  priceRange,
  breadcrumbName,
  faqs = []
} = Astro.props;

const siteUrl = 'https://torweb.pl';
const fullOgImage = ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`;
// URL BEZ /uslugi/ - bezpośrednio /{serviceSlug}
const serviceUrl = `${siteUrl}/${serviceSlug}`;

// Schema: Organization
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "ProfessionalService",
  "@id": `${siteUrl}/#organization`,
  "name": "TorWeb.pl - Agencja Interaktywna",
  "url": siteUrl,
  "logo": `${siteUrl}/logo.svg`,
  "telephone": "+48509370772",
  "email": "kontakt@torweb.pl",
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Toruń",
    "addressRegion": "Kujawsko-Pomorskie",
    "postalCode": "87-100",
    "addressCountry": "PL"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": 53.0138,
    "longitude": 18.5984
  },
  "areaServed": [
    { "@type": "City", "name": "Toruń" },    
    { "@type": "City", "name": "Grudziądz" },
    { "@type": "City", "name": "Włocławek" },
    { "@type": "Country", "name": "Polska" }
  ]
};

// Schema: Service
const serviceSchema = {
  "@context": "https://schema.org",
  "@type": "Service",
  "@id": `${serviceUrl}/#service`,
  "name": serviceName,
  "description": description,
  "url": serviceUrl,
  "serviceType": serviceCategory,
  "provider": {
    "@type": "ProfessionalService",
    "@id": `${siteUrl}/#organization`
  },
  "areaServed": {
    "@type": "Country",
    "name": "Polska"
  },
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": serviceName,
    "itemListElement": [
      {
        "@type": "Offer",
        "itemOffered": {
          "@type": "Service",
          "name": serviceName
        },
        "priceSpecification": {
          "@type": "PriceSpecification",
          "priceCurrency": "PLN",
          "price": priceRange
        }
      }
    ]
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.9",
    "reviewCount": "47",
    "bestRating": "5",
    "worstRating": "1"
  }
};

// Schema: BreadcrumbList - BEZ zagnieżdżenia /uslugi/
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Strona główna",
      "item": siteUrl
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": breadcrumbName,
      "item": serviceUrl
    }
  ]
};

// Schema: FAQPage
const faqSchema = faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
} : null;

// Schema: WebPage
const webPageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "@id": `${serviceUrl}/#webpage`,
  "url": serviceUrl,
  "name": title,
  "description": description,
  "isPartOf": {
    "@type": "WebSite",
    "@id": `${siteUrl}/#website`
  },
  "about": {
    "@type": "Service",
    "@id": `${serviceUrl}/#service`
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "@id": `${serviceUrl}/#breadcrumb`
  },
  "inLanguage": "pl-PL",
  "potentialAction": {
    "@type": "ReadAction",
    "target": serviceUrl
  }
};

// Related services - BEZ /uslugi/
const allServices = [
  { name: 'Strony internetowe', slug: 'strony-internetowe', short: 'Strony WWW' },
  { name: 'Sklepy internetowe', slug: 'sklepy-internetowe', short: 'E-commerce' },
  { name: 'Aplikacje webowe', slug: 'aplikacje-webowe', short: 'Aplikacje' },
  { name: 'Integracje AI', slug: 'integracje-ai', short: 'AI' },
  { name: 'Automatyzacja', slug: 'automatyzacja', short: 'Automatyzacja' },
  { name: 'Migracje sklepów', slug: 'migracje-sklepow', short: 'Migracje' }
];

const relatedServices = allServices.filter(s => s.slug !== serviceSlug);
---

<!doctype html>
<html lang="pl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Theme initialization -->
  <script is:inline>
    (function() {
      const theme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.classList.remove('light', 'dark');
      document.documentElement.classList.add(theme);
    })();
  </script>
  
  <!-- Primary Meta Tags -->
  <title>{title}</title>
  <meta name="title" content={title} />
  <meta name="description" content={description} />
  <meta name="keywords" content={keywords} />
  <meta name="author" content="TorWeb.pl - Karol Leszczyński" />
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <link rel="canonical" href={canonical || serviceUrl} />
  
  <!-- Geo Tags -->
  <meta name="geo.region" content="PL-KP" />
  <meta name="geo.placename" content="Toruń" />
  <meta name="geo.position" content="53.0138;18.5984" />
  <meta name="ICBM" content="53.0138, 18.5984" />
  
  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={serviceUrl} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={fullOgImage} />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="pl_PL" />
  <meta property="og:site_name" content="TorWeb.pl" />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={serviceUrl} />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={fullOgImage} />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://api.fontshare.com/v2/css?f[]=clash-display@400,500,600,700&f[]=satoshi@400,500,700&display=swap" rel="stylesheet" />
  
  <!-- Preconnect to Google domains -->
  <link rel="preconnect" href="https://www.googletagmanager.com" />
  <link rel="preconnect" href="https://www.google-analytics.com" />
  
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(webPageSchema)} />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#050506" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
</head>

<body class="bg-page antialiased overflow-x-hidden transition-colors duration-300">
  <!-- Google Tag Manager (noscript) -->
  <noscript>
    <iframe 
      src="https://www.googletagmanager.com/ns.html?id=GTM-NVNG92JP"
      height="0" 
      width="0" 
      style="display:none;visibility:hidden"
      title="Google Tag Manager"
    ></iframe>
  </noscript>
  
  <!-- Background -->
  <div class="fixed inset-0 -z-10 bg-page">
    <div class="absolute inset-0 bg-gradient-overlay"></div>
    <div class="absolute top-0 left-1/4 w-[600px] h-[600px] rounded-full blur-[150px] dark-blur" 
         style="background: rgba(0, 255, 136, 0.05);"></div>
    <div class="absolute bottom-1/4 right-1/4 w-[500px] h-[500px] rounded-full blur-[150px] dark-blur" 
         style="background: rgba(0, 212, 255, 0.05);"></div>
  </div>
  <div class="fixed inset-0 -z-10 grid-pattern"></div>

  <Navbar />
  
  <!-- Breadcrumbs - BEZ zagnieżdżenia /uslugi/ -->
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-4" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-sm text-muted">
      <li>
        <a href="/" class="hover:text-accent transition-colors">Strona główna</a>
      </li>
      <li class="flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span class="text-heading font-medium">{breadcrumbName}</span>
      </li>
    </ol>
  </nav>

  <!-- Main Content -->
  <main>
    <slot />
    
    <!-- Related Services - linki BEZ /uslugi/ -->
    <section class="py-16 border-t border-theme">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-heading mb-8">Inne usługi</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
          {relatedServices.map(service => (
            <a 
              href={`/${service.slug}`}
              class="group p-4 rounded-xl border border-theme bg-card hover:border-accent/50 transition-all duration-300"
            >
              <span class="text-body group-hover:text-accent transition-colors">{service.short}</span>
            </a>
          ))}
        </div>
      </div>
    </section>
    
    <!-- CTA Section -->
    <section class="py-20 bg-elevated">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-heading mb-4">
          Gotowy na <span class="text-accent">współpracę</span>?
        </h2>
        <p class="text-lg text-muted mb-8 max-w-2xl mx-auto">
          Skontaktuj się z nami i otrzymaj bezpłatną wycenę projektu w ciągu 24 godzin.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/kontakt" class="btn-primary">
            Bezpłatna wycena
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </a>
          <a href="tel:+48509370772" class="btn-secondary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            509 370 772
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
  
  <!-- Cookie Consent Banner -->
  <CookieBanner />
  
  <script>
    const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-visible');
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);
    document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
  </script>
</body>
</html>

<style is:global>
  .dark .dark-blur { opacity: 1; }
  .light .dark-blur { opacity: 0; }
  
  .grid-pattern {
    opacity: 0.02;
    background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23888888" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
  }
  .light .grid-pattern { opacity: 0.03; }
</style>